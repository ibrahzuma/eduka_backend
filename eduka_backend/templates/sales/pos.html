{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<style>
    .pos-excel-container {
        max-width: 100%;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
    }

    .pos-header {
        padding: 15px 20px;
        border-bottom: 2px solid #f0f2f5;
        background: #f8f9fa;
    }

    .pos-grid-wrapper {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: auto;
        /* Enable horizontal scrolling */
        padding: 0;
        position: relative;
    }

    .excel-table {
        width: 100%;
        min-width: 600px;
        /* Force minimum width to prevent squishing on phones */
        border-collapse: collapse;
    }

    .excel-table th {
        background: #f1f3f4;
        color: #5f6368;
        font-weight: 600;
        font-size: 13px;
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
        border-right: 1px solid #e0e0e0;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .excel-table td {
        border-bottom: 1px solid #e0e0e0;
        border-right: 1px solid #e0e0e0;
        padding: 0;
        margin: 0;
    }

    .cell-input {
        width: 100%;
        border: none;
        padding: 12px 10px;
        outline: none;
        font-size: 14px;
        color: #202124;
        background: transparent;
        font-family: inherit;
    }

    .cell-input:focus {
        background: #e8f0fe;
        box-shadow: inset 0 0 0 2px #1a73e8;
    }

    .cell-readonly {
        background: #f8f9fa;
        color: #5f6368;
        pointer-events: none;
    }

    .row-index {
        text-align: center;
        width: 40px;
        background: #f1f3f4;
        color: #5f6368;
        font-size: 12px;
    }

    .pos-footer {
        padding: 15px 20px;
        border-top: 2px solid #f0f2f5;
        background: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .total-display {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1a73e8;
    }

    .btn-action {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        color: #d93025;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-action:hover {
        background: #fce8e6;
    }
</style>

<div class="container-fluid p-0">
    <form method="post" id="posForm" onsubmit="prepareSubmission(event)">
        {% csrf_token %}
        <input type="hidden" name="items_json" id="itemsInput">

        <div class="pos-excel-container">
            <!-- Header: Customer & Meta Info -->
            <div class="pos-header">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <label class="small text-muted fw-bold">Customer</label>
                        {{ form.customer }}
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">Payment Method</label>
                        {{ form.payment_method }}
                    </div>
                    <div class="col-md-5 text-end">
                        <h5 class="m-0 fw-bold text-dark">New Sale Invoice</h5>
                        <small class="text-muted">{% now "l, d M Y" %}</small>
                    </div>
                </div>
            </div>

            <!-- Excel Grid -->
            <div class="pos-grid-wrapper">
                <table class="excel-table" id="posTable">
                    <thead>
                        <tr>
                            <th class="row-index">#</th>
                            <th style="width: 40%;">Item Description / Code</th>
                            <th style="width: 15%;">Stock</th>
                            <th style="width: 15%;">Unit Price</th>
                            <th style="width: 10%;">Qty</th>
                            <th style="width: 15%;">Total</th>
                            <th style="width: 5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="gridBody">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Footer: Totals & Action -->
            <div class="pos-footer">
                <div class="d-flex align-items-center gap-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="addRow()">
                        <i class="bi bi-plus-lg me-1"></i> Add Row
                    </button>
                    <small class="text-muted">Tip: Press <strong>Enter</strong> in Qty to add new row.</small>
                </div>

                <div class="text-end d-flex align-items-center gap-4">
                    <div>
                        <div class="small text-muted text-uppercase fw-bold">Total Payable</div>
                        <div class="total-display" id="grandTotal">0.00</div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg px-5 shadow-sm" id="checkoutBtn">
                        <i class="bi bi-check-lg me-2"></i> Complete Sale
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Datalist for Product Autocomplete -->
<datalist id="productList">
    {% for product in products %}
    <option value="{{ product.name }}" data-id="{{ product.id }}" data-price="{{ product.selling_price }}"
        data-stock="{{ product.stock_qty|default:0 }}">
        CODE: {{ product.sku }} | Stock: {{ product.stock_qty|default:0 }}
    </option>
    {% endfor %}
</datalist>

<!-- JavaScript Data Source -->
<script>
    // Preload product data for fast lookup - Using quotes to avoid localization number format issues
    const PRODUCTS_DB = [
        {% for product in products %}
    {
        id: "{{ product.id }}",
            name: "{{ product.name|escapejs }}",
                sku: "{{ product.sku|escapejs }}",
                    price: parseFloat("{{ product.selling_price|default:0 }}"),
                        stock: parseFloat("{{ product.stock_qty|default:0 }}")
    },
    {% endfor %}
    ];

    let rowCount = 0;

    // Wait for DOM
    document.addEventListener('DOMContentLoaded', function () {
        init();

        // Prevent implicit submission on Enter for non-submit inputs
        document.getElementById('posForm').onkeypress = function (e) {
            var key = e.charCode || e.keyCode || 0;
            if (key == 13) {
                // Allow enter on submit button or textarea
                if (e.target.type !== 'submit' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            }
        }
    });

    function init() {
        addRow(); // Add initial row
    }

    window.addRow = function () {
        rowCount++;
        // Use insertAdjacentHTML for better performance or createElement
        const tbody = document.getElementById('gridBody');
        const tr = document.createElement('tr');
        tr.id = `row-${rowCount}`;

        tr.innerHTML = `
            <td class="row-index text-center align-middle bg-light text-muted" style="font-size:12px;">${rowCount}</td>
            <td>
                <input type="text" class="cell-input product-search" list="productList" 
                       placeholder="Scan or type product name..." 
                       oninput="handleProductInput(this, ${rowCount})"
                       onkeydown="handleNav(event, this, ${rowCount}, 'prod')"
                       autocomplete="off">
                <input type="hidden" class="item-id" id="id-${rowCount}">
            </td>
            <td>
                <input type="text" class="cell-input cell-readonly stock-display" id="stock-${rowCount}" readonly tabindex="-1">
            </td>
             <td>
                <input type="number" class="cell-input price-input" id="price-${rowCount}" 
                       step="0.01" oninput="calcRow(${rowCount})"
                       placeholder="0.00">
            </td>
            <td>
                <input type="number" class="cell-input qty-input" id="qty-${rowCount}" 
                       value="" min="1" 
                       oninput="calcRow(${rowCount})"
                       onkeydown="handleNav(event, this, ${rowCount}, 'qty')"
                       placeholder="1">
            </td>
            <td>
                <input type="text" class="cell-input cell-readonly row-total" id="total-${rowCount}" readonly tabindex="-1" value="0.00">
            </td>
            <td class="text-center align-middle">
                <button type="button" class="btn-action" onclick="deleteRow(this)" tabindex="-1">
                    <i class="bi bi-x-lg"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);

        // Auto focus
        setTimeout(() => {
            const input = tr.querySelector('.product-search');
            if (input) input.focus();
        }, 50);
    }

    window.handleNav = function (e, input, rowId, type) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Stop form submit
            if (type === 'prod') {
                if (input.value) {
                    // if has value, move to qty
                    document.getElementById(`qty-${rowId}`).focus();
                }
            } else if (type === 'qty') {
                // Determine if we need a new row
                const tbody = document.getElementById('gridBody');
                const rows = tbody.querySelectorAll('tr');
                const lastRowId = rows[rows.length - 1].id.split('-')[1];

                // If it's the last row and has value, add new
                if (String(rowId) === String(lastRowId)) {
                    if (input.value !== '') {
                        addRow();
                    }
                } else {
                    // Focus next row product
                    const nextRow = input.closest('tr').nextElementSibling;
                    if (nextRow) {
                        nextRow.querySelector('.product-search').focus();
                    }
                }
            }
        }
    }

    window.handleProductInput = function (input, rowId) {
        const val = input.value;
        const product = PRODUCTS_DB.find(p => p.name === val || p.sku === val);

        if (product) {
            document.getElementById(`id-${rowId}`).value = product.id;
            document.getElementById(`stock-${rowId}`).value = product.stock;
            document.getElementById(`price-${rowId}`).value = product.price;
            if (!document.getElementById(`qty-${rowId}`).value) {
                document.getElementById(`qty-${rowId}`).value = 1;
            }
            calcRow(rowId);
        }
    }

    window.calcRow = function (rowId) {
        const qty = parseFloat(document.getElementById(`qty-${rowId}`).value) || 0;
        const price = parseFloat(document.getElementById(`price-${rowId}`).value) || 0;
        const total = qty * price;
        document.getElementById(`total-${rowId}`).value = total.toLocaleString(undefined, { minimumFractionDigits: 2 });
        calcGrandTotal();
    }

    window.calcGrandTotal = function () {
        let grandTotal = 0;
        document.querySelectorAll('.row-total').forEach(input => {
            const val = parseFloat(input.value.replace(/,/g, '')) || 0;
            grandTotal += val;
        });
        document.getElementById('grandTotal').innerText = grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, style: 'currency', currency: 'TZS' });
    }

    window.deleteRow = function (btn) {
        const row = btn.closest('tr');
        if (document.querySelectorAll('#gridBody tr').length > 1) {
            row.remove();
            reindexRows();
            calcGrandTotal();
        } else {
            row.querySelectorAll('input').forEach(i => i.value = '');
            calcGrandTotal();
        }
    }

    window.reindexRows = function () {
        let index = 1;
        document.querySelectorAll('.row-index').forEach(cell => {
            cell.innerText = index++;
        });
    }

    window.prepareSubmission = function (event) {
        const items = [];
        const rows = document.querySelectorAll('#gridBody tr');
        let isValid = false;

        rows.forEach(row => {
            const idInput = row.querySelector('.item-id');
            const qtyInput = row.querySelector('.qty-input');
            const priceInput = row.querySelector('.price-input');

            if (idInput.value && qtyInput.value > 0) {
                items.push({
                    id: idInput.value,
                    qty: qtyInput.value,
                    price: priceInput.value
                });
                isValid = true;
            }
        });

        if (!isValid) {
            event.preventDefault();
            alert("Cart is empty! Please add at least one item.");
            return false;
        }

        document.getElementById('itemsInput').value = JSON.stringify(items);
        const btn = document.getElementById('checkoutBtn');
        if (btn) btn.disabled = true;
        return true;
    }
</script>
{% endblock %}
{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-gray-900 mb-1">User Management</h1>
            <p class="text-muted mb-0">Manage all registered users across the system</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="fetchUsers()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Stats Row (Optional, can be dynamic later) -->
    <!-- <div class="row g-4 mb-4" id="stats-row"> ... </div> -->

    <!-- Filters -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0"
                            placeholder="Search by username, email, or phone...">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-primary filter-btn active" data-role="">All Users</button>
                        <button class="btn btn-light border filter-btn" data-role="OWNER">Owners</button>
                        <button class="btn btn-light border filter-btn" data-role="EMPLOYEE">Employees</button>
                        <button class="btn btn-light border filter-btn" data-role="SUPER_ADMIN">Admins</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover">
                <thead class="bg-light">
                    <tr>
                        <th class="px-4 py-3 text-uppercase small fw-bold text-secondary">User</th>
                        <th class="px-4 py-3 text-uppercase small fw-bold text-secondary">Role</th>
                        <th class="px-4 py-3 text-uppercase small fw-bold text-secondary">Shop(s)</th>
                        <th class="px-4 py-3 text-uppercase small fw-bold text-secondary">Joined</th>
                        <th class="px-4 py-3 text-uppercase small fw-bold text-secondary">Status</th>
                        <th class="px-4 py-3 text-uppercase small fw-bold text-secondary text-end">Action</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- Dynamic Content -->
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <div class="spinner-border text-primary"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentRole = '';

    document.addEventListener('DOMContentLoaded', function () {
        fetchUsers();

        // Search Listener
        const searchInput = document.getElementById('searchInput');
        let timeout = null;
        searchInput.addEventListener('input', function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => fetchUsers(), 300);
        });

        // Filter Buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Update UI
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('btn-primary', 'active');
                    b.classList.add('btn-light', 'border');
                });
                this.classList.remove('btn-light', 'border');
                this.classList.add('btn-primary', 'active');

                // Update Logic
                currentRole = this.dataset.role;
                fetchUsers();
            });
        });
    });

    function fetchUsers() {
        const query = document.getElementById('searchInput').value;
        const url = `/api/auth/manage/?q=${encodeURIComponent(query)}&role=${encodeURIComponent(currentRole)}`;
        const tbody = document.getElementById('userTableBody');

        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

        fetch(url)
            .then(res => res.json())
            .then(data => {
                renderTable(data);
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-danger">Error loading users.</td></tr>';
            });
    }

    function renderTable(users) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">No users found.</td></tr>';
            return;
        }

        users.forEach(user => {
            let roleBadge = '';
            if (user.role === 'OWNER') roleBadge = '<span class="badge bg-primary bg-opacity-10 text-primary">Owner</span>';
            else if (user.role === 'EMPLOYEE') roleBadge = '<span class="badge bg-secondary bg-opacity-10 text-secondary">Employee</span>';
            else if (user.is_superuser) roleBadge = '<span class="badge bg-dark">Super Admin</span>';
            else roleBadge = `<span class="badge bg-light text-dark border">${user.role}</span>`;

            let shopsHtml = user.shop_name.length ?
                user.shop_name.map(s => `<span class="badge bg-info bg-opacity-10 text-info border border-info me-1">${s}</span>`).join('')
                : '<span class="text-muted small">-</span>';

            let statusBadge = user.is_active ?
                '<span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Active</span>' :
                '<span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3">Banned</span>';

            let actionsHtml = '';
            // Don't show actions for Super Admins unless it's yourself (logic handled in backend mostly, but UX hint here)
            if (!user.is_superuser) {
                const toggleBtn = user.is_active ?
                    `<button class="btn btn-sm btn-outline-danger" title="Ban" onclick="handleAction('ban', ${user.id})"><i class="bi bi-slash-circle"></i></button>` :
                    `<button class="btn btn-sm btn-outline-success" title="Activate" onclick="handleAction('activate', ${user.id})"><i class="bi bi-check-circle"></i></button>`;

                actionsHtml = `
                    ${toggleBtn}
                    <button class="btn btn-sm btn-outline-dark ms-1" title="Delete" onclick="handleAction('delete', ${user.id})"><i class="bi bi-trash"></i></button>
                `;
            }

            const row = `
                <tr>
                    <td class="px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold me-3" style="width: 40px; height: 40px;">
                                ${user.initial}
                            </div>
                            <div>
                                <div class="fw-bold text-dark">${user.username}</div>
                                <div class="small text-muted">${user.email}</div>
                                ${user.phone ? `<div class="small text-primary fw-bold" style="font-size: 0.7rem;"><i class="bi bi-telephone me-1"></i>${user.phone}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">${roleBadge}</td>
                    <td class="px-4 py-3">${shopsHtml}</td>
                    <td class="px-4 py-3 text-secondary small">${user.formatted_date}</td>
                    <td class="px-4 py-3">${statusBadge}</td>
                    <td class="px-4 py-3 text-end">${actionsHtml}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function handleAction(action, userId) {
        if (!confirm(`Are you sure you want to ${action.toUpperCase()} this user?`)) return;

        // Get CSRF Token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

        fetch('/api/auth/action/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Django needs this
            },
            body: JSON.stringify({ action: action, user_id: userId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' || data.status === 'deleted') {
                    // Refresh list
                    fetchUsers();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Failed to perform action.');
            });
    }
</script>
{% endblock %}
{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container py-4">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-gray-900 display-6">Choose the Right Plan for Your Shop</h1>
        <p class="text-muted lead">Simple, transparent pricing. Upgrade or downgrade anytime.</p>
    </div>

    <!-- Container for dynamic cards -->
    <div class="row justify-content-center g-4" id="plansContainer">
        <!-- Loading Spinner -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading plans...</p>
        </div>
    </div>

    <div class="text-center mt-5 text-muted small">
        <p>Prices are in Tanzanian Shillings (TZS). Need a custom plan? <a href="#">Contact Sales</a>.</p>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="modal-header bg-gradient-primary text-white border-0 py-3">
                    <h5 class="modal-title fw-bold mx-auto"><i class="bi bi-wallet2 me-2"></i>Complete Payment</h5>
                    <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3"
                        data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <!-- Step 1: Input -->
                    <div id="paymentStep1">
                        <div class="mb-4">
                            <span
                                class="badge bg-light text-primary rounded-pill px-3 py-2 mb-2 text-uppercase fw-bold small tracking-wide">Secure
                                Checkout</span>
                            <h2 class="text-dark fw-bold mb-0" id="paymentAmountDisplay"></h2>
                            <p class="text-muted small">Instant activation via Mobile Money</p>
                        </div>

                        <div class="text-start mb-4">
                            <label class="form-label text-muted small fw-bold text-uppercase">Mobile Number</label>
                            <div class="input-group input-group-lg shadow-sm rounded-3 overflow-hidden">
                                <span class="input-group-text bg-white border-end-0 text-muted ps-3"><i
                                        class="bi bi-phone"></i></span>
                                <input type="tel" id="mobileNumber" class="form-control border-start-0 ps-2"
                                    placeholder="07XXXXXXXX" required style="font-size: 1.1rem; letter-spacing: 1px;">
                            </div>
                            <div class="form-text small text-muted mt-2"><i
                                    class="bi bi-shield-lock-fill me-1"></i>Supports M-Pesa, Tigo, Airtel, Halo</div>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg fw-bold rounded-3 shadow-sm py-3"
                                onclick="initiatePayment()">
                                Pay Now <i class="bi bi-arrow-right-short ms-1"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Loading / Polling -->
                    <div id="paymentStep2" class="d-none py-4">
                        <div class="spinner-border text-primary mb-4" role="status"
                            style="width: 4rem; height: 4rem; border-width: 4px;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="fw-bold text-dark">Check Your Phone</h5>
                        <p class="text-muted mb-4 px-3">We sent a prompt to <strong id="displayPhone"
                                class="text-dark"></strong>. Enter your PIN to confirm.</p>

                        <div
                            class="alert alert-warning bg-opacity-10 border-0 rounded-3 d-flex align-items-center justify-content-center p-3">
                            <div class="spinner-grow spinner-grow-sm text-warning me-2" role="status"></div>
                            <span class="small text-warning fw-bold">Waiting for confirmation...</span>
                        </div>
                    </div>

                    <!-- Step 3: Success -->
                    <div id="paymentStep3" class="d-none py-4">
                        <div class="mb-4">
                            <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex p-4 mb-3">
                                <i class="bi bi-check-lg text-success" style="font-size: 3.5rem;"></i>
                            </div>
                            <h4 class="fw-bold text-dark">Payment Successful!</h4>
                            <p class="text-muted small">Your subscription is now active.</p>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-success btn-lg fw-bold rounded-3 shadow-sm"
                                onclick="location.reload()">
                                Go to Dashboard
                            </button>
                        </div>
                    </div>
                    <!-- Step 4: Error -->
                    <div id="paymentStep4" class="d-none py-4">
                        <div class="mb-4">
                            <div class="rounded-circle bg-danger bg-opacity-10 d-inline-flex p-4 mb-3">
                                <i class="bi bi-x-lg text-danger" style="font-size: 3.5rem;"></i>
                            </div>
                            <h5 class="fw-bold text-dark">Payment Failed</h5>
                            <p class="text-muted small px-2" id="errorMessage">Something went wrong.</p>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-light fw-bold text-muted" onclick="resetModal()">Try Again</button>
                            <button class="btn btn-outline-secondary btn-sm border-0"
                                data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .bg-gradient-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        }
    </style>
</div>

<script>
    let selectedPlanId = null;
    let selectedCycle = null;
    let pollInterval = null;

    document.addEventListener("DOMContentLoaded", function () {
        fetchPlans();
    });

    function fetchPlans() {
        // Updated API Endpoint
        fetch('/subscriptions/api/plans/')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('plansContainer');
                container.innerHTML = ''; // Clear loading state

                if (data.length > 0) {
                    data.forEach(plan => {
                        renderPlan(plan);
                    });
                } else {
                    container.innerHTML = '<div class="col-12 text-center text-muted"><p>No subscription plans currently available.</p></div>';
                }
            })
            .catch(error => {
                console.error('Error fetching plans:', error);
                document.getElementById('plansContainer').innerHTML = '<div class="col-12 text-center text-danger"><p>Failed to load pricing plans.</p></div>';
            });
    }

    function renderPlan(plan) {
        const container = document.getElementById('plansContainer');

        // Parse features for display
        // Assuming features is a dict like {"shops": 1, "users": 1, ...}
        // or we allow a generic display list. 
        // Let's hardcode some icons or logic based on keys, or just generic list.
        let featuresHtml = '';
        const features = plan.features || {};

        // Custom feature rendering based on root fields
        if (plan.max_shops) featuresHtml += `<li class="mb-3 d-flex align-items-center"><i class="bi bi-check-circle-fill text-success me-2"></i> <span>${plan.max_shops} Shop</span></li>`;
        if (plan.max_users) featuresHtml += `<li class="mb-3 d-flex align-items-center"><i class="bi bi-check-circle-fill text-success me-2"></i> <span>${plan.max_users} Staffs</span></li>`;
        if (features.products) featuresHtml += `<li class="mb-3 d-flex align-items-center"><i class="bi bi-check-circle-fill text-success me-2"></i> <span>${features.products.toLocaleString()} Products</span></li>`;

        // Priority Support
        featuresHtml += `<li class="mb-3 d-flex align-items-center"><i class="bi bi-check-circle-fill text-success me-2"></i> <span>Priority Support</span></li>`;


        const cardHtml = `
        <div class="col-xl-3 col-lg-4 col-md-6 col-12 fade-in-up">
            <div class="card h-100 border-0 shadow-lg rounded-4 overflow-hidden text-center transition-hover">
                <div class="bg-primary bg-opacity-10 py-2">
                     <h4 class="fw-bold text-primary mb-0 text-uppercase small spacing-wide">${plan.name}</h4>
                </div>
                
                <div class="card-body p-5 d-flex flex-column">
                    <div class="pricing-display mb-4">
                         <h2 class="fw-bold text-dark mb-0">${plan.display_price} <small class="fs-6 text-muted">TZS</small></h2>
                    </div>

                     <ul class="list-unstyled text-start mb-5 mx-auto small text-muted">
                        ${featuresHtml}
                    </ul>

                    <div class="mt-auto">
                        <button onclick="openPaymentModal('${plan.id}', '${plan.cycle}', '${plan.display_price}')" 
                            class="btn btn-primary fw-bold w-100 py-3 shadow-sm scale-on-hover px-4">
                            Subscribe
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHtml);
    }

    function openPaymentModal(planId, cycle, priceDisplay) {
        selectedPlanId = planId;
        selectedCycle = cycle;
        // Strip TZS or just set text
        document.getElementById('paymentAmountDisplay').innerText = priceDisplay + " TZS";

        // Reset Steps
        resetModal();

        const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        modal.show();
    }

    function resetModal() {
        document.getElementById('paymentStep1').classList.remove('d-none');
        document.getElementById('paymentStep2').classList.add('d-none');
        document.getElementById('paymentStep3').classList.add('d-none');
        document.getElementById('paymentStep4').classList.add('d-none');
        document.getElementById('mobileNumber').value = '';
        clearInterval(pollInterval);
    }

    function initiatePayment() {
        const phone = document.getElementById('mobileNumber').value;
        if (!phone) {
            alert("Please enter a phone number");
            return;
        }

        // Show Loading
        document.getElementById('paymentStep1').classList.add('d-none');
        document.getElementById('paymentStep2').classList.remove('d-none');
        document.getElementById('displayPhone').innerText = phone;

        // API Call - Updated Endpoint
        fetch('/subscriptions/initiate-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                plan_id: selectedPlanId,
                cycle: selectedCycle, // This is now passed from the plan object
                phone_number: phone
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Start Polling
                    startPolling(data.payment_id);
                } else {
                    showError(data.message || 'Payment initiation failed.');
                }
            })
            .catch(err => {
                console.error(err);
                showError('Connection error.');
            });
    }

    function startPolling(paymentId) {
        pollInterval = setInterval(() => {
            // Updated Endpoint
            fetch(`/subscriptions/check-status/${paymentId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'COMPLETED') {
                        clearInterval(pollInterval);
                        showSuccess();
                    } else if (data.status === 'FAILED') {
                        clearInterval(pollInterval);
                        showError(data.message || 'Payment failed or was cancelled.');
                    }
                })
                .catch(err => console.error('Polling error', err));
        }, 3000); // Check every 3 seconds
    }

    function showSuccess() {
        document.getElementById('paymentStep2').classList.add('d-none');
        document.getElementById('paymentStep3').classList.remove('d-none');
    }

    function showError(msg) {
        document.getElementById('paymentStep1').classList.add('d-none');
        document.getElementById('paymentStep2').classList.add('d-none');
        document.getElementById('paymentStep4').classList.remove('d-none');
        document.getElementById('errorMessage').innerText = msg;
    }
</script>

<style>
    .transition-hover {
        transition: transform 0.2s;
    }

    .transition-hover:hover {
        transform: translateY(-5px);
    }

    .scale-on-hover:hover {
        transform: scale(1.02);
    }
</style>
{% endblock %}